<%- include('../layouts/main', {title: 'My Profile'}) %>

<div class="container my-5">
  <h1 class="mb-4">My Profile</h1>

  <div class="row">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5>Personal Information</h5>
        </div>
        <div class="card-body">
          <form id="profileForm">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" readonly>
              <small class="text-muted">Email cannot be changed</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="phone">
            </div>

            <button type="submit" class="btn btn-primary">Update Profile</button>
          </form>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5>Shipping Address</h5>
        </div>
        <div class="card-body">
          <form id="addressForm">
            <div class="mb-3">
              <label class="form-label">Address</label>
              <input type="text" class="form-control" name="address">
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">City</label>
                <input type="text" class="form-control" name="city">
              </div>
              <div class="col-md-3">
                <label class="form-label">State</label>
                <input type="text" class="form-control" name="state">
              </div>
              <div class="col-md-3">
                <label class="form-label">ZIP Code</label>
                <input type="text" class="form-control" name="zipCode">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Country</label>
              <input type="text" class="form-control" name="country" value="USA">
            </div>

            <button type="submit" class="btn btn-primary">Save Address</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5>Change Password</h5>
        </div>
        <div class="card-body">
          <form id="passwordForm">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control" name="currentPassword" required>
            </div>

            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control" name="newPassword" required minlength="6">
            </div>

            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" name="confirmPassword" required minlength="6">
            </div>

            <button type="submit" class="btn btn-primary">Change Password</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-user-circle fa-5x text-muted"></i>
          </div>
          <h5 id="userName"></h5>
          <p class="text-muted" id="userEmail"></p>
          <p class="text-muted">Member since <span id="memberSince"></span></p>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title">Account Statistics</h6>
          <div class="d-flex justify-content-between mb-2">
            <span>Total Orders:</span>
            <strong id="totalOrders">0</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Total Spent:</span>
            <strong id="totalSpent">$0.00</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  await loadUserProfile();
});

async function loadUserProfile() {
  try {
    const response = await fetch('/api/auth/me', {
      credentials: 'include'
    });
    const data = await response.json();

    if (data.success) {
      populateProfile(data.user);
    }
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

function populateProfile(user) {
  // Sidebar info
  document.getElementById('userName').textContent = user.name;
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('memberSince').textContent = new Date(user.createdAt).toLocaleDateString();

  // Profile form
  const profileForm = document.getElementById('profileForm');
  profileForm.name.value = user.name || '';
  profileForm.email.value = user.email || '';
  profileForm.phone.value = user.phone || '';

  // Address form
  if (user.shippingAddress) {
    const addr = JSON.parse(user.shippingAddress);
    const addressForm = document.getElementById('addressForm');
    addressForm.address.value = addr.address || '';
    addressForm.city.value = addr.city || '';
    addressForm.state.value = addr.state || '';
    addressForm.zipCode.value = addr.zipCode || '';
    addressForm.country.value = addr.country || 'USA';
  }

  // Load stats
  loadUserStats();
}

async function loadUserStats() {
  try {
    const response = await fetch('/api/orders', {
      credentials: 'include'
    });
    const data = await response.json();

    if (data.success) {
      document.getElementById('totalOrders').textContent = data.orders.length;
      const totalSpent = data.orders.reduce((sum, order) => sum + parseFloat(order.total), 0);
      document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
    }
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Profile form submission
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    name: formData.get('name'),
    phone: formData.get('phone')
  };

  try {
    const response = await fetch('/api/auth/profile', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
      showToast('Profile updated successfully', 'success');
    } else {
      showToast(result.message, 'error');
    }
  } catch (error) {
    showToast('Error updating profile', 'error');
  }
});

// Address form submission
document.getElementById('addressForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const shippingAddress = {
    address: formData.get('address'),
    city: formData.get('city'),
    state: formData.get('state'),
    zipCode: formData.get('zipCode'),
    country: formData.get('country')
  };

  try {
    const response = await fetch('/api/auth/profile', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ shippingAddress: JSON.stringify(shippingAddress) })
    });

    const result = await response.json();
    if (result.success) {
      showToast('Address updated successfully', 'success');
    } else {
      showToast(result.message, 'error');
    }
  } catch (error) {
    showToast('Error updating address', 'error');
  }
});

// Password form submission
document.getElementById('passwordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  
  if (formData.get('newPassword') !== formData.get('confirmPassword')) {
    showToast('Passwords do not match', 'error');
    return;
  }

  const data = {
    currentPassword: formData.get('currentPassword'),
    newPassword: formData.get('newPassword')
  };

  try {
    const response = await fetch('/api/auth/change-password', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
      showToast('Password changed successfully', 'success');
      e.target.reset();
    } else {
      showToast(result.message, 'error');
    }
  } catch (error) {
    showToast('Error changing password', 'error');
  }
});
</script>

<%- include('../layouts/main_end') %>
